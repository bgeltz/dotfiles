#!/bin/bash

set -e
# set -x

PROCS=9
TEST_FLAGS=''
# TEST_FLAGS+=' --enable-debug'
# TEST_FLAGS+=' --enable-overhead'
# TEST_FLAGS+=' --disable-fortran'
# TEST_FLAGS+=' --disable-mpi'
# TEST_FLAGS+=' --disable-openmp'
# TEST_FLAGS+=' --disable-doc'
# TEST_FLAGS+=' --enable-coverage'
# TEST_FLAGS+=' --enable-ompt'
# TEST_FLAGS+=' --with-python=python2'
TEST_FLAGS+=' --enable-bloat'

GEOPM_PATH=${BIN_PATH}/geopm

if [ -n "${MAKE_CLEAN}" ]; then
    git clean -fdx
    rm -f VERSION
    rm -fr ${GEOPM_PATH}
fi

if [ -n "${FORCE_DEBUG}" ]; then
    TEST_FLAGS+=' --enable-debug'
fi

if [ -n "${RUN_COVERAGE}" ]; then
    TEST_FLAGS+=' --enable-coverage'
fi

./autogen.sh
./configure --prefix=${GEOPM_PATH} ${TEST_FLAGS}
make -j${PROCS}
# make install # Moved this to build_and_run.sh so that when running for coverage, the in-tree binaries are used.

if [ -n "${RUN_TESTS}" ]; then
    make -j${PROCS} checkprogs
    make check
fi
